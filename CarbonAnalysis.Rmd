---
title: "CarbonAnalysis"
author: "ikebenaka"
date: "2023-03-27"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(GGally)
library(lme4)
library(lmerTest)
library(car)
library(sjPlot)
library(performance)
library(Amelia)
library(mosaic)
library(Sleuth3)
library(car)
library(lmtest)
library(MASS)
library(AER)
library(pscl)
library(gridExtra)
```

```{r}
soil <- read.csv("soil.csv")
soil <- soil %>%
  rename %>%
  mutate(soil = case_when(
    soil == "FF" ~ "Forest floor",
    soil == "MIN" ~ "Mineral soil",
    TRUE ~ soil)) %>%
  mutate(site = case_when(
    site == "P1" ~ "Plow 1",
    site == "P2" ~ "Plow 2",
    site == "S1" ~ "Pasture 1",
    site == "S2" ~ "Pasture 2",
    site == "W1" ~ "Woodlot 1",
    site == "W2" ~ "Woodlot 2",
    TRUE ~ site))

#Remove NAs
soil <- na.omit(soil)

#Factor classes
soil$stake <- as.factor(soil$stake)
soil$row <- as.factor(soil$row)
soil$site <- as.factor(soil$site)

ggpairs(soil, c("site", "row", "stake", "soil", "soil.mass", "soil.moisture", "c","n","ph.h2o","om"))


```

```{r, minimum adequate model}
#Create a model --> carbon as dependent variable
sc1 <- lmer(c ~ factor(site) + (1|row) + (1|stake) + ff.thickness + bulk.density + soil.mass + om+ph.h2o+n+p+nh4+no3+ca+mg+k + soil.moisture + soil.moisture.capacity + n.min+nitr + cec, data = soil)
summary(sc1)
sc2 <- lmer(c ~ factor(site) + (1|row) + (1|stake) + bulk.density + om + ph.h2o + n + nh4 + soil.moisture, data = soil)
summary(sc2)
sc3 <- lmer(c ~ factor(site) + (1|row) + (1|stake) + bulk.density + om + ph.h2o + n + soil.moisture, data = soil)
summary(sc3)
sc4 <- lmer(c ~ factor(site) + (1|row) + (1|stake) + bulk.density + om + ph.h2o + n, data = soil)
summary(sc4)
sc5 <- lmer(c ~ factor(site) + (1|row) + (1|stake) + om + ph.h2o + n, data = soil)
summary(sc5)
sc6 <- lmer(c ~ factor(site) + (1|row) + (1|stake) + om + n, data = soil)
summary(sc6)



log10(max(df$CONT+1) - df$CONT)


AIC(sc1,sc2,sc3,sc4,sc5,sc6,sc7) #sc4 with lowest AIC
lrtest(sc1,sc2,sc3,sc4,sc5,sc6,sc7) #sc4 fits the data equally well as the full model, sc6 fits data as well as sc5
vif(sc4)
vif(sc6)
plot(sc7)
```

```{r, check transformations}
#sc9 and sc12 look a little better

sc7 <- lmer(log(c) ~ factor(site) + (1|row) + (1|stake) + om + n, data = soil)
summary(sc7)

sc8 <- lmer(asin(sqrt(c/100)) ~ factor(site) + (1|row) + (1|stake) + om + n, data = soil)
summary(sc8)

sc9 <- lmer((c)^2 ~ factor(site) + (1|row) + (1|stake) + om + n, data = soil)
summary(sc9)

sc10 <- lmer(log10(max(c+1)-c) ~ factor(site) + (1|row) + (1|stake) + om + n, data = soil)
summary(sc10)

sc11 <- lmer(c^3 ~ factor(site) + (1|row) + (1|stake) + om + n, data = soil)
summary(sc11)

sc12 <- lmer(sqrt(max(c+1) - c) ~ factor(site) + (1|row) + (1|stake) + om + n, data = soil)
summary(sc12)

AIC(sc1,sc2,sc3,sc4,sc5,sc6,sc7,sc8,sc9,sc10,sc11,sc12)
plot(sc6)
plot(sc7)
plot(sc8)
plot(sc9)
plot(sc10)
plot(sc11)
plot(sc12)

check_model(sc6)
check_model(sc7)
check_model(sc8)
check_model(sc9)
check_model(sc12)

check_model(sc9)
grid.arrange(
  sc9diag[2],
  sc9diag[3],
  sc9diag[4],
  sc9diag[6],
  ncol=2
)
```


```{r, Check assumptions using diagnostics}
#fitted vs residual
plot(sc6, type=c("p","smooth"), col.line=1)
#scale-location
plot(sc6,
     sqrt(abs(resid(.)))~fitted(.),
     type=c("p","smooth"), col.line=1)
#QQ
lattice::qqmath(sc6)
#residuals vs leverage
plot(sc6, rstudent(.) ~ hatvalues(.))

#fitted vs residual
plot(sc9, type=c("p","smooth"), col.line=1)
#scale-location
plot(sc9,
     sqrt(abs(resid(.)))~fitted(.),
     type=c("p","smooth"), col.line=1)
#QQ
lattice::qqmath(sc9)
#residuals vs leverage
plot(sc9, rstudent(.) ~ hatvalues(.))
```


```{r}
ggplot(soil, aes(x=site,y=c))+
  geom_boxplot()
```

# Percent Soil Carbon

With the null hypothesis that the percent carbon in the soil would not change across the different land use types or based on changes to percent nitrogen and percent organic matter, I created a mixed linear model that included row and stake as random effects, and colonial land use type, percent organic matter, and percent nitrogen as fixed effects. The alternative hypothesis for this model was that the percent carbon in the soil would change with at least one of the fixed effects. My initial model included variables that previous studies associated with soil carbon content in their modeling approaches (Compton and Boone 2000, Li et al. 2020, Finzi et al. 2020). I used backward elimination of non-significant independent variables to derive the minimum adequate model. I compared the model using AIC values and checked model fit using the likelihood ratio test. I checked for multicollinearity using VIF (variance inflation factor) values.
â€¢ mention transformation/standardization of variables
